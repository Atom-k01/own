name: 自动更新 embyicon/embyicon.json

on:
  push:
    paths:
      - 'embyicon/**'
      - '.github/workflows/embyicon.yml'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Generate embyicon.json
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');

          // 定位到 embyicon 文件夹
          const ICON_DIR = path.join(process.cwd(), 'embyicon');
          if (!fs.existsSync(ICON_DIR)) {
            console.error('Error: embyicon directory not found at', ICON_DIR);
            process.exit(1);
          }

          // 读取图片文件
          const files = fs.readdirSync(ICON_DIR)
            .filter(f => /\.(png|jpe?g|svg)$/i.test(f));

          // 构建列表
          const list = files.map(name => ({
            name,
            url: `https://raw.githubusercontent.com/${process.env.GITHUB_REPOSITORY}/main/embyicon/${encodeURIComponent(name)}`
          }));

          // 包装为对象形式：{ "icons": [...] }
          const output = { icons: list };

          // 写入 embyicon.json
          const outputPath = path.join(ICON_DIR, 'embyicon.json');
          fs.writeFileSync(
            outputPath,
            JSON.stringify(output, null, 2),
            'utf-8'
          );
          console.log('✔ embyicon.json generated at', outputPath);
          EOF

      - name: Commit and push embyicon.json
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: 🔄 自动更新 embyicon/embyicon.json"
          file_pattern: "embyicon/embyicon.json"
          branch: "main"
