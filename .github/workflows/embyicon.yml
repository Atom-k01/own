name: è‡ªåŠ¨æ›´æ–° embyicon/embyicon.json

on:
  push:
    paths:
      - 'embyicon/**'
      - '.github/workflows/embyicon.yml'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Generate embyicon.json
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const crypto = require('crypto');

          function fileHash(filePath) {
            if (!fs.existsSync(filePath)) return null;
            const data = fs.readFileSync(filePath);
            return crypto.createHash('sha1').update(data).digest('hex');
          }

          const ICON_DIR = path.join(process.cwd(), 'embyicon');
          const OUTPUT_PATH = path.join(ICON_DIR, 'embyicon.json');

          if (!fs.existsSync(ICON_DIR)) {
            console.error('Error: embyicon directory not found at', ICON_DIR);
            process.exit(1);
          }

          // è¯»å–å¹¶æŒ‰å­—æ¯ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰æ’åºå›¾ç‰‡æ–‡ä»¶
          const files = fs.readdirSync(ICON_DIR)
            .filter(f => /\.(png|jpe?g|svg)$/i.test(f))
            .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

          // å–å½“å‰åˆ†æ”¯å
          const branch = process.env.GITHUB_REF_NAME || 'main';

          // æ„å»ºåˆ—è¡¨
          const list = files.map(name => ({
            name,
            url: `https://raw.githubusercontent.com/${process.env.GITHUB_REPOSITORY}/${branch}/embyicon/${encodeURIComponent(name)}`
          }));

          // åŒ…è£…ä¸ºå¯¹è±¡å½¢å¼ï¼Œå¢åŠ  name å’Œ description å­—æ®µ
          const output = {
            name: "EmbyIcon",Â Â Â Â Â 
            description: "By Atom",
            icons: listÂ Â 
          };

          // ç”Ÿæˆæ–°å†…å®¹
          const newContent = JSON.stringify(output, null, 2) + "\n";

          // æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          const oldHash = fileHash(OUTPUT_PATH);
          const newHash = crypto.createHash('sha1').update(newContent).digest('hex');

          if (oldHash === newHash) {
            console.log('âœ… No changes detected. Skip writing.');
            process.exit(0);
          }

          // å†™å…¥æ–°æ–‡ä»¶
          fs.writeFileSync(OUTPUT_PATH, newContent, 'utf-8');
          console.log('âœ” embyicon.json updated.');
          EOF

      - name: Commit and push if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "ci: ğŸ”„ è‡ªåŠ¨æ›´æ–° embyicon/embyicon.json"
          file_pattern: "embyicon/embyicon.json"
          branch: "main"
          skip_dirty_check: false
